!function(n){var e={};function t(r){if(e[r])return e[r].exports;var a=e[r]={i:r,l:!1,exports:{}};return n[r].call(a.exports,a,a.exports,t),a.l=!0,a.exports}t.m=n,t.c=e,t.d=function(n,e,r){t.o(n,e)||Object.defineProperty(n,e,{enumerable:!0,get:r})},t.r=function(n){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},t.t=function(n,e){if(1&e&&(n=t(n)),8&e)return n;if(4&e&&"object"==typeof n&&n&&n.__esModule)return n;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:n}),2&e&&"string"!=typeof n)for(var a in n)t.d(r,a,function(e){return n[e]}.bind(null,a));return r},t.n=function(n){var e=n&&n.__esModule?function(){return n.default}:function(){return n};return t.d(e,"a",e),e},t.o=function(n,e){return Object.prototype.hasOwnProperty.call(n,e)},t.p="/",t(t.s=3)}({3:function(module,exports,__webpack_require__){eval('module.exports = __webpack_require__("P4sp");\n\n\n//# sourceURL=webpack:///multi_./resources/widget/client.js?')},P4sp:function(module,__webpack_exports__,__webpack_require__){"use strict";eval("// ESM COMPAT FLAG\n__webpack_require__.r(__webpack_exports__);\n\n// CONCATENATED MODULE: ./resources/widget/connector.js\nfunction _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction _defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction _createClass(Constructor, protoProps, staticProps) { if (protoProps) _defineProperties(Constructor.prototype, protoProps); if (staticProps) _defineProperties(Constructor, staticProps); return Constructor; }\n\nvar Connector = /*#__PURE__*/function () {\n  function Connector() {\n    _classCallCheck(this, Connector);\n\n    this.requests = {};\n    this.subscribe();\n  }\n\n  _createClass(Connector, [{\n    key: \"send\",\n    value: function send(frameID, data) {\n      var _this = this;\n\n      return new Promise(function (resolve, reject) {\n        var key = _this._makeid(10);\n\n        var payload = {\n          type: 'request',\n          name: 'envy::widget',\n          key: key,\n          widgetID: data.widgetID,\n          frameID: frameID,\n          method: data.method,\n          data: data.data\n        };\n        _this.requests[key] = {\n          resolve: resolve,\n          reject: reject\n        };\n        window.top.postMessage(payload, '*');\n      });\n    }\n  }, {\n    key: \"resolveRequest\",\n    value: function resolveRequest(data) {\n      if (this.requests.hasOwnProperty(data.key)) {\n        this.requests[data.key].resolve(data.data);\n        delete this.requests[data.key];\n      }\n    }\n  }, {\n    key: \"subscribe\",\n    value: function subscribe() {\n      var _this2 = this;\n\n      window.addEventListener('message', function (event) {\n        if (event.data.type === 'request') {\n          //ловим обратный запрос\n          _this2.resolveRequest(event.data);\n        }\n      });\n    }\n  }, {\n    key: \"_makeid\",\n    value: function _makeid(length) {\n      var result = '';\n      var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\n      var charactersLength = characters.length;\n\n      for (var i = 0; i < length; i++) {\n        result += characters.charAt(Math.floor(Math.random() * charactersLength));\n      }\n\n      return result;\n    }\n  }]);\n\n  return Connector;\n}();\n\n/* harmony default export */ var connector = (Connector);\n// CONCATENATED MODULE: ./resources/widget/widget.js\nfunction _typeof(obj) { \"@babel/helpers - typeof\"; if (typeof Symbol === \"function\" && typeof Symbol.iterator === \"symbol\") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === \"function\" && obj.constructor === Symbol && obj !== Symbol.prototype ? \"symbol\" : typeof obj; }; } return _typeof(obj); }\n\nfunction widget_classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError(\"Cannot call a class as a function\"); } }\n\nfunction widget_defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if (\"value\" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } }\n\nfunction widget_createClass(Constructor, protoProps, staticProps) { if (protoProps) widget_defineProperties(Constructor.prototype, protoProps); if (staticProps) widget_defineProperties(Constructor, staticProps); return Constructor; }\n\n\n\nvar widget_EnvyCrmWidget = /*#__PURE__*/function () {\n  function EnvyCrmWidget() {\n    widget_classCallCheck(this, EnvyCrmWidget);\n\n    this.connector = new connector();\n    this.blocks = null;\n    this.frameID = this.parseFromSource('frame_id'); //хэш виджета для обращении\n\n    this.widgetID = this.parseFromSource('widget_id'); //ид виджета из бд\n  }\n  /**\n   * Первичная инициализация\n   * @param blocks\n   */\n\n\n  widget_createClass(EnvyCrmWidget, [{\n    key: \"init\",\n    value: function init(blocks) {\n      this.blocks = blocks;\n      this.subscribe();\n      this.send('loaded');\n    }\n    /**\n     * Отправка эвента об инициализации\n     */\n\n  }, {\n    key: \"initialize\",\n    value: function initialize() {\n      this.send('init', {\n        widgetID: this.widgetID,\n        blocks: Object.keys(this.blocks)\n      });\n    }\n    /**\n     * Подписка на эвенты от окна\n     */\n\n  }, {\n    key: \"subscribe\",\n    value: function subscribe() {\n      var _this = this;\n\n      window.addEventListener('message', function (event) {\n        if (event.data.method === 'loaded') {\n          _this.widgetID = event.data.data.widgetID;\n\n          _this.initialize();\n        }\n\n        if (event.data.method === 'getBlocks') {\n          var type = event.data.data.type;\n          var params = event.data.data.params;\n\n          if (_this.blocks[type]) {\n            _this.send('blocks', {\n              type: type,\n              widgetID: _this.widgetID,\n              blocks: _this.blocks[type](params)\n            });\n          }\n        }\n      });\n    }\n    /**\n     * отправка эвентов\n     * @param method\n     * @param data\n     */\n\n  }, {\n    key: \"send\",\n    value: function send(method, data) {\n      var message = {\n        name: 'envy::widget',\n        method: method\n      };\n\n      if (data) {\n        message['data'] = data;\n      }\n\n      window.top.postMessage(message, '*');\n    }\n  }, {\n    key: \"sendAwait\",\n    value: function sendAwait(method, data) {\n      var _this2 = this;\n\n      var params = {\n        name: 'envy::widget',\n        widgetID: this.widgetID,\n        method: method,\n        data: data\n      };\n      return new Promise(function (resolve, reject) {\n        _this2.connector.send(_this2.frameID, params).then(function (data) {\n          resolve(data);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"getDealValue\",\n    value: function getDealValue(data) {\n      var _this3 = this;\n\n      return new Promise(function (resolve, reject) {\n        var types = ['service', 'custom'];\n\n        if (!types.includes(data.type)) {\n          reject('Укажите корректный тип поля');\n          return;\n        }\n\n        if (!data.input_id) {\n          reject('Укажите id поля');\n          return;\n        }\n\n        _this3.sendAwait('getDealValue', {\n          inputID: data.input_id,\n          type: data.type\n        }).then(function (data) {\n          resolve(data);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"getDeal\",\n    value: function getDeal() {\n      var _this4 = this;\n\n      return new Promise(function (resolve, reject) {\n        _this4.sendAwait('getDeal').then(function (data) {\n          resolve(data);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"changeDealValue\",\n    value: function changeDealValue(data) {\n      var _this5 = this;\n\n      return new Promise(function (resolve, reject) {\n        if (!data.input_id) {\n          reject('Укажите id поля');\n          return;\n        }\n\n        if (!data.hasOwnProperty('value')) {\n          reject('Укажите значение');\n          return;\n        }\n\n        _this5.sendAwait('changeDealValue', {\n          inputID: data.input_id,\n          value: data.value\n        }).then(function (data) {\n          resolve(data);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"getClientValue\",\n    value: function getClientValue(data) {\n      var _this6 = this;\n\n      return new Promise(function (resolve, reject) {\n        var types = ['service', 'custom'];\n\n        if (!types.includes(data.type)) {\n          reject('Укажите корректный тип поля');\n          return;\n        }\n\n        if (!data.input_id) {\n          reject('Укажите id поля');\n          return;\n        }\n\n        _this6.sendAwait('getClientValue', {\n          inputID: data.input_id,\n          type: data.type\n        }).then(function (data) {\n          resolve(data);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"changeClientValue\",\n    value: function changeClientValue(data) {\n      var _this7 = this;\n\n      return new Promise(function (resolve, reject) {\n        if (!data.input_id) {\n          reject('Укажите id поля');\n          return;\n        }\n\n        if (!data.hasOwnProperty('value')) {\n          reject('Укажите значение');\n          return;\n        }\n\n        _this7.sendAwait('changeClientValue', {\n          inputID: data.input_id,\n          value: data.value\n        }).then(function (data) {\n          resolve(data);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"openModal\",\n    value: function openModal(data) {\n      var _this8 = this;\n\n      return new Promise(function (resolve, reject) {\n        if (!data.content) {\n          reject('Укажите url');\n          return;\n        }\n\n        _this8.sendAwait('openModal', {\n          title: data.title,\n          type: data.type,\n          content: data.content,\n          width: data.width\n        }).then(function (data) {\n          resolve(data);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"getParams\",\n    value: function getParams() {\n      var _this9 = this;\n\n      var type = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 'all';\n      var types = ['all', 'global', 'user'];\n\n      if (!types.includes(type)) {\n        type = 'all';\n      }\n\n      return new Promise(function (resolve, reject) {\n        _this9.sendAwait('getParams', {\n          type: type\n        }).then(function (data) {\n          resolve(data); //print(1);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"saveParams\",\n    value: function saveParams(params) {\n      var _this10 = this;\n\n      if (_typeof(params) !== \"object\") {\n        console.log('only object');\n        return;\n      }\n\n      return new Promise(function (resolve, reject) {\n        _this10.sendAwait('saveParams', {\n          params: params\n        }).then(function (data) {\n          resolve(data); //print(1);\n        })[\"catch\"](function (e) {\n          reject(e);\n        });\n      });\n    }\n  }, {\n    key: \"parseFromSource\",\n    value: function parseFromSource(key) {\n      var urlParams = new URLSearchParams(window.location.hash.replace(\"#\", \"?\"));\n      return urlParams.get(key);\n    }\n  }]);\n\n  return EnvyCrmWidget;\n}();\n\n/* harmony default export */ var widget = (widget_EnvyCrmWidget);\n// CONCATENATED MODULE: ./resources/widget/client.js\n // eslint-disable-next-line func-names\n\n(function () {\n  // eslint-disable-next-line global-require\n  window.EnvyCrmWidget = new widget();\n})();\n\n//# sourceURL=webpack:///./resources/widget/client.js_+_2_modules?")}});